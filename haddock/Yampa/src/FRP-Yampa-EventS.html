<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/FRP/Yampa/EventS.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE GADTs, Rank2Types, CPP      #-}</span>
<a name="line-2"></a><span class='hs-comment'>-----------------------------------------------------------------------------------------</span>
<a name="line-3"></a><span class='hs-comment'>-- |</span>
<a name="line-4"></a><span class='hs-comment'>-- Module      :  FRP.Yampa.EventS</span>
<a name="line-5"></a><span class='hs-comment'>-- Copyright   :  (c) Antony Courtney and Henrik Nilsson, Yale University, 2003</span>
<a name="line-6"></a><span class='hs-comment'>-- License     :  BSD-style (see the LICENSE file in the distribution)</span>
<a name="line-7"></a><span class='hs-comment'>--</span>
<a name="line-8"></a><span class='hs-comment'>-- Maintainer  :  ivan.perez@keera.co.uk</span>
<a name="line-9"></a><span class='hs-comment'>-- Stability   :  provisional</span>
<a name="line-10"></a><span class='hs-comment'>-- Portability :  non-portable (GHC extensions)</span>
<a name="line-11"></a><span class='hs-comment'>-- </span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>-----------------------------------------------------------------------------------------</span>
<a name="line-14"></a>
<a name="line-15"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>EventS</span> <span class='hs-layout'>(</span>
<a name="line-16"></a>
<a name="line-17"></a>    <span class='hs-comment'>-- * Basic event sources</span>
<a name="line-18"></a>    <span class='hs-varid'>never</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- :: SF a (Event b)</span>
<a name="line-19"></a>    <span class='hs-varid'>now</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- :: b -&gt; SF a (Event b)</span>
<a name="line-20"></a>    <span class='hs-varid'>after</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- :: Time -&gt; b -&gt; SF a (Event b)</span>
<a name="line-21"></a>    <span class='hs-varid'>repeatedly</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- :: Time -&gt; b -&gt; SF a (Event b)</span>
<a name="line-22"></a>    <span class='hs-varid'>afterEach</span><span class='hs-layout'>,</span>          <span class='hs-comment'>-- :: [(Time,b)] -&gt; SF a (Event b)</span>
<a name="line-23"></a>    <span class='hs-varid'>afterEachCat</span><span class='hs-layout'>,</span>       <span class='hs-comment'>-- :: [(Time,b)] -&gt; SF a (Event [b])</span>
<a name="line-24"></a>    <span class='hs-varid'>delayEvent</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- :: Time -&gt; SF (Event a) (Event a)</span>
<a name="line-25"></a>    <span class='hs-varid'>delayEventCat</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- :: Time -&gt; SF (Event a) (Event [a])</span>
<a name="line-26"></a>    <span class='hs-varid'>edge</span><span class='hs-layout'>,</span>               <span class='hs-comment'>-- :: SF Bool (Event ())</span>
<a name="line-27"></a>    <span class='hs-varid'>iEdge</span><span class='hs-layout'>,</span>              <span class='hs-comment'>-- :: Bool -&gt; SF Bool (Event ())</span>
<a name="line-28"></a>    <span class='hs-varid'>edgeTag</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- :: a -&gt; SF Bool (Event a)</span>
<a name="line-29"></a>    <span class='hs-varid'>edgeJust</span><span class='hs-layout'>,</span>           <span class='hs-comment'>-- :: SF (Maybe a) (Event a)</span>
<a name="line-30"></a>    <span class='hs-varid'>edgeBy</span><span class='hs-layout'>,</span>             <span class='hs-comment'>-- :: (a -&gt; a -&gt; Maybe b) -&gt; a -&gt; SF a (Event b)</span>
<a name="line-31"></a>
<a name="line-32"></a>    <span class='hs-comment'>-- * Stateful event suppression</span>
<a name="line-33"></a>    <span class='hs-varid'>notYet</span><span class='hs-layout'>,</span>             <span class='hs-comment'>-- :: SF (Event a) (Event a)</span>
<a name="line-34"></a>    <span class='hs-varid'>once</span><span class='hs-layout'>,</span>               <span class='hs-comment'>-- :: SF (Event a) (Event a)</span>
<a name="line-35"></a>    <span class='hs-varid'>takeEvents</span><span class='hs-layout'>,</span>         <span class='hs-comment'>-- :: Int -&gt; SF (Event a) (Event a)</span>
<a name="line-36"></a>    <span class='hs-varid'>dropEvents</span>          <span class='hs-comment'>-- :: Int -&gt; SF (Event a) (Event a)</span>
<a name="line-37"></a>
<a name="line-38"></a>    <span class='hs-comment'>-- ** Pointwise functions on events</span>
<a name="line-39"></a>    <span class='hs-comment'>-- noEvent,            -- :: Event a</span>
<a name="line-40"></a>    <span class='hs-comment'>-- noEventFst,         -- :: (Event a, b) -&gt; (Event c, b)</span>
<a name="line-41"></a>    <span class='hs-comment'>-- noEventSnd,         -- :: (a, Event b) -&gt; (a, Event c)</span>
<a name="line-42"></a>    <span class='hs-comment'>-- event,              -- :: a -&gt; (b -&gt; a) -&gt; Event b -&gt; a</span>
<a name="line-43"></a>    <span class='hs-comment'>-- fromEvent,          -- :: Event a -&gt; a</span>
<a name="line-44"></a>    <span class='hs-comment'>-- isEvent,            -- :: Event a -&gt; Bool</span>
<a name="line-45"></a>    <span class='hs-comment'>-- isNoEvent,          -- :: Event a -&gt; Bool</span>
<a name="line-46"></a>    <span class='hs-comment'>-- tag,                -- :: Event a -&gt; b -&gt; Event b,          infixl 8</span>
<a name="line-47"></a>    <span class='hs-comment'>-- tagWith,            -- :: b -&gt; Event a -&gt; Event b,</span>
<a name="line-48"></a>    <span class='hs-comment'>-- attach,             -- :: Event a -&gt; b -&gt; Event (a, b),     infixl 8</span>
<a name="line-49"></a>    <span class='hs-comment'>-- lMerge,             -- :: Event a -&gt; Event a -&gt; Event a,    infixl 6</span>
<a name="line-50"></a>    <span class='hs-comment'>-- rMerge,             -- :: Event a -&gt; Event a -&gt; Event a,    infixl 6</span>
<a name="line-51"></a>    <span class='hs-comment'>-- merge,              -- :: Event a -&gt; Event a -&gt; Event a,    infixl 6</span>
<a name="line-52"></a>    <span class='hs-comment'>-- mergeBy,            -- :: (a -&gt; a -&gt; a) -&gt; Event a -&gt; Event a -&gt; Event a</span>
<a name="line-53"></a>    <span class='hs-comment'>-- mapMerge,           -- :: (a -&gt; c) -&gt; (b -&gt; c) -&gt; (a -&gt; b -&gt; c) </span>
<a name="line-54"></a>    <span class='hs-comment'>--                     --    -&gt; Event a -&gt; Event b -&gt; Event c</span>
<a name="line-55"></a>    <span class='hs-comment'>-- mergeEvents,        -- :: [Event a] -&gt; Event a</span>
<a name="line-56"></a>    <span class='hs-comment'>-- catEvents,          -- :: [Event a] -&gt; Event [a]</span>
<a name="line-57"></a>    <span class='hs-comment'>-- joinE,              -- :: Event a -&gt; Event b -&gt; Event (a,b),infixl 7</span>
<a name="line-58"></a>    <span class='hs-comment'>-- splitE,             -- :: Event (a,b) -&gt; (Event a, Event b)</span>
<a name="line-59"></a>    <span class='hs-comment'>-- filterE,            -- :: (a -&gt; Bool) -&gt; Event a -&gt; Event a</span>
<a name="line-60"></a>    <span class='hs-comment'>-- mapFilterE,         -- :: (a -&gt; Maybe b) -&gt; Event a -&gt; Event b</span>
<a name="line-61"></a>    <span class='hs-comment'>-- gate,               -- :: Event a -&gt; Bool -&gt; Event a,       infixl 8</span>
<a name="line-62"></a>
<a name="line-63"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-64"></a>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>InternalCore</span> <span class='hs-layout'>(</span><span class='hs-conid'>SF</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>sfConst</span><span class='hs-layout'>,</span> <span class='hs-conid'>Time</span><span class='hs-layout'>,</span> <span class='hs-conid'>SF'</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>Basic</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>Diagnostics</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>Event</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>Miscellany</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>Scan</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FRP</span><span class='hs-varop'>.</span><span class='hs-conid'>Yampa</span><span class='hs-varop'>.</span><span class='hs-conid'>Switches</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-comment'>-- -- The event-processing function *could* accept the present NoEvent</span>
<a name="line-77"></a><span class='hs-comment'>-- -- output as an extra state argument. That would facilitate composition</span>
<a name="line-78"></a><span class='hs-comment'>-- -- of event-processing functions somewhat, but would presumably incur an</span>
<a name="line-79"></a><span class='hs-comment'>-- -- extra cost for the more common and simple case of non-composed event</span>
<a name="line-80"></a><span class='hs-comment'>-- -- processors.</span>
<a name="line-81"></a><span class='hs-comment'>-- </span>
<a name="line-82"></a><span class='hs-comment'>-- sfEP :: (c -&gt; a -&gt; (c, b, b)) -&gt; c -&gt; b -&gt; SF' (Event a) b</span>
<a name="line-83"></a><span class='hs-comment'>-- sfEP f c bne = sf</span>
<a name="line-84"></a><span class='hs-comment'>--     where</span>
<a name="line-85"></a><span class='hs-comment'>--         sf = SFEP (\_ ea -&gt; case ea of</span>
<a name="line-86"></a><span class='hs-comment'>--                                  NoEvent -&gt; (sf, bne)</span>
<a name="line-87"></a><span class='hs-comment'>--                                  Event a -&gt; let</span>
<a name="line-88"></a><span class='hs-comment'>--                                                 (c', b, bne') = f c a</span>
<a name="line-89"></a><span class='hs-comment'>--                                             in</span>
<a name="line-90"></a><span class='hs-comment'>--                                                 (sfEP f c' bne', b))</span>
<a name="line-91"></a><span class='hs-comment'>--                   f</span>
<a name="line-92"></a><span class='hs-comment'>--                   c</span>
<a name="line-93"></a><span class='hs-comment'>--                   bne</span>
<a name="line-94"></a><span class='hs-comment'>-- </span>
<a name="line-95"></a><span class='hs-comment'>-- </span>
<a name="line-96"></a><span class='hs-comment'>-- -- epPrim is used to define hold, accum, and other event-processing</span>
<a name="line-97"></a><span class='hs-comment'>-- -- functions.</span>
<a name="line-98"></a><span class='hs-comment'>-- epPrim :: (c -&gt; a -&gt; (c, b, b)) -&gt; c -&gt; b -&gt; SF (Event a) b</span>
<a name="line-99"></a><span class='hs-comment'>-- epPrim f c bne = SF {sfTF = tf0}</span>
<a name="line-100"></a><span class='hs-comment'>--     where</span>
<a name="line-101"></a><span class='hs-comment'>--         tf0 NoEvent   = (sfEP f c bne, bne)</span>
<a name="line-102"></a><span class='hs-comment'>--         tf0 (Event a) = let</span>
<a name="line-103"></a><span class='hs-comment'>--                             (c', b, bne') = f c a</span>
<a name="line-104"></a><span class='hs-comment'>--                         in</span>
<a name="line-105"></a><span class='hs-comment'>--                             (sfEP f c' bne', b)</span>
<a name="line-106"></a>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-comment'>{-
<a name="line-109"></a>-- !!! Maybe something like this?
<a name="line-110"></a>-- !!! But one problem is that the invarying marking would be lost
<a name="line-111"></a>-- !!! if the signal function is taken apart and re-constructed from
<a name="line-112"></a>-- !!! the function description and subordinate signal function in
<a name="line-113"></a>-- !!! cases like SFCpAXA.
<a name="line-114"></a>sfMkInv :: SF a b -&gt; SF a b
<a name="line-115"></a>sfMkInv sf = SF {sfTF = ...}
<a name="line-116"></a>
<a name="line-117"></a>    sfMkInvAux :: SF' a b -&gt; SF' a b
<a name="line-118"></a>    sfMkInvAux sf@(SFArr _ _) = sf
<a name="line-119"></a>    -- sfMkInvAux sf@(SFAcc _ _ _ _) = sf
<a name="line-120"></a>    sfMkInvAux sf@(SFEP _ _ _ _) = sf
<a name="line-121"></a>    sfMkInvAux sf@(SFCpAXA tf inv fd1 sf2 fd3)
<a name="line-122"></a>        | inv       = sf
<a name="line-123"></a>        | otherwise = SFCpAXA tf' True fd1 sf2 fd3
<a name="line-124"></a>        where
<a name="line-125"></a>            tf' = \dt a -&gt; let (sf', b) = tf dt a in (sfMkInvAux sf', b)
<a name="line-126"></a>    sfMkInvAux sf@(SF' tf inv)
<a name="line-127"></a>        | inv       = sf
<a name="line-128"></a>        | otherwise = SF' tf' True
<a name="line-129"></a>            tf' = 
<a name="line-130"></a>
<a name="line-131"></a>-}</span>
<a name="line-132"></a>
<a name="line-133"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-134"></a><span class='hs-comment'>-- Basic event sources</span>
<a name="line-135"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="never"></a><span class='hs-comment'>-- | Event source that never occurs.</span>
<a name="line-138"></a><span class='hs-comment'>{-# ANN never "HLint: ignore Use const" #-}</span>
<a name="line-139"></a><span class='hs-definition'>never</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SF</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-definition'>never</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>{</span><span class='hs-varid'>sfTF</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sfNever</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-141"></a>
<a name="line-142"></a><a name="sfNever"></a><span class='hs-definition'>sfNever</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SF'</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-143"></a><span class='hs-definition'>sfNever</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sfConst</span> <span class='hs-conid'>NoEvent</span>
<a name="line-144"></a>
<a name="line-145"></a><a name="now"></a><span class='hs-comment'>-- | Event source with a single occurrence at time 0. The value of the event</span>
<a name="line-146"></a><span class='hs-comment'>-- is given by the function argument.</span>
<a name="line-147"></a><span class='hs-definition'>now</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-148"></a><span class='hs-definition'>now</span> <span class='hs-varid'>b0</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Event</span> <span class='hs-varid'>b0</span> <span class='hs-varop'>--&gt;</span> <span class='hs-varid'>never</span>
<a name="line-149"></a>
<a name="line-150"></a>
<a name="line-151"></a><a name="after"></a><span class='hs-comment'>-- | Event source with a single occurrence at or as soon after (local) time /q/</span>
<a name="line-152"></a><span class='hs-comment'>-- as possible.</span>
<a name="line-153"></a><span class='hs-definition'>after</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Time</span> <span class='hs-comment'>-- ^ The time /q/ after which the event should be produced</span>
<a name="line-154"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>    <span class='hs-comment'>-- ^ Value to produce at that time</span>
<a name="line-155"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-156"></a><span class='hs-definition'>after</span> <span class='hs-varid'>q</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>afterEach</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-157"></a>
<a name="line-158"></a><span class='hs-comment'>-- | Event source with repeated occurrences with interval q.</span>
<a name="line-159"></a><span class='hs-comment'>-- Note: If the interval is too short w.r.t. the sampling intervals,</span>
<a name="line-160"></a><span class='hs-comment'>-- the result will be that events occur at every sample. However, no more</span>
<a name="line-161"></a><span class='hs-comment'>-- than one event results from any sampling interval, thus avoiding an</span>
<a name="line-162"></a><span class='hs-comment'>-- "event backlog" should sampling become more frequent at some later</span>
<a name="line-163"></a><span class='hs-comment'>-- point in time.</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-comment'>-- !!! 2005-03-30:  This is potentially a bit inefficient since we KNOW</span>
<a name="line-166"></a><span class='hs-comment'>-- !!! (at this level) that the SF is going to be invarying. But afterEach</span>
<a name="line-167"></a><span class='hs-comment'>-- !!! does NOT know this as the argument list may well be finite.</span>
<a name="line-168"></a><span class='hs-comment'>-- !!! We could use sfMkInv, but that's not without problems.</span>
<a name="line-169"></a><span class='hs-comment'>-- !!! We're probably better off specializing afterEachCat here.</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="repeatedly"></a><span class='hs-definition'>repeatedly</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Time</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-172"></a><span class='hs-definition'>repeatedly</span> <span class='hs-varid'>q</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>afterEach</span> <span class='hs-varid'>qxs</span>
<a name="line-173"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usrErr</span> <span class='hs-str'>"AFRP"</span> <span class='hs-str'>"repeatedly"</span> <span class='hs-str'>"Non-positive period."</span>
<a name="line-174"></a>    <span class='hs-keyword'>where</span>
<a name="line-175"></a>        <span class='hs-varid'>qxs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>qxs</span>        
<a name="line-176"></a>
<a name="line-177"></a>
<a name="line-178"></a><span class='hs-comment'>-- Event source with consecutive occurrences at the given intervals.</span>
<a name="line-179"></a><span class='hs-comment'>-- Should more than one event be scheduled to occur in any sampling interval,</span>
<a name="line-180"></a><span class='hs-comment'>-- only the first will in fact occur to avoid an event backlog.</span>
<a name="line-181"></a><span class='hs-comment'>-- Question: Should positive periods except for the first one be required?</span>
<a name="line-182"></a><span class='hs-comment'>-- Note that periods of length 0 will always be skipped except for the first.</span>
<a name="line-183"></a><span class='hs-comment'>-- Right now, periods of length 0 is allowed on the grounds that no attempt</span>
<a name="line-184"></a><span class='hs-comment'>-- is made to forbid simultaneous events elsewhere.</span>
<a name="line-185"></a><span class='hs-comment'>{-
<a name="line-186"></a>afterEach :: [(Time,b)] -&gt; SF a (Event b)
<a name="line-187"></a>afterEach [] = never
<a name="line-188"></a>afterEach ((q,x):qxs)
<a name="line-189"></a>    | q &lt; 0     = usrErr "AFRP" "afterEach" "Negative period."
<a name="line-190"></a>    | otherwise = SF {sfTF = tf0}
<a name="line-191"></a>    where
<a name="line-192"></a>        tf0 _ = if q &lt;= 0 then
<a name="line-193"></a>                    (scheduleNextEvent 0.0 qxs, Event x)
<a name="line-194"></a>                else
<a name="line-195"></a>                    (awaitNextEvent (-q) x qxs, NoEvent)
<a name="line-196"></a>
<a name="line-197"></a>        scheduleNextEvent t [] = sfNever
<a name="line-198"></a>        scheduleNextEvent t ((q,x):qxs)
<a name="line-199"></a>            | q &lt; 0     = usrErr "AFRP" "afterEach" "Negative period."
<a name="line-200"></a>            | t' &gt;= 0   = scheduleNextEvent t' qxs
<a name="line-201"></a>            | otherwise = awaitNextEvent t' x qxs
<a name="line-202"></a>            where
<a name="line-203"></a>                t' = t - q
<a name="line-204"></a>        awaitNextEvent t x qxs = SF' {sfTF' = tf}
<a name="line-205"></a>            where
<a name="line-206"></a>                tf dt _ | t' &gt;= 0   = (scheduleNextEvent t' qxs, Event x)
<a name="line-207"></a>                        | otherwise = (awaitNextEvent t' x qxs, NoEvent)
<a name="line-208"></a>                    where
<a name="line-209"></a>                        t' = t + dt
<a name="line-210"></a>-}</span>
<a name="line-211"></a>
<a name="line-212"></a><span class='hs-comment'>-- | Event source with consecutive occurrences at the given intervals.</span>
<a name="line-213"></a><span class='hs-comment'>-- Should more than one event be scheduled to occur in any sampling interval,</span>
<a name="line-214"></a><span class='hs-comment'>-- only the first will in fact occur to avoid an event backlog.</span>
<a name="line-215"></a>
<a name="line-216"></a><a name="afterEach"></a><span class='hs-comment'>-- After all, after, repeatedly etc. are defined in terms of afterEach.</span>
<a name="line-217"></a><span class='hs-definition'>afterEach</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Time</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-218"></a><span class='hs-definition'>afterEach</span> <span class='hs-varid'>qxs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>afterEachCat</span> <span class='hs-varid'>qxs</span> <span class='hs-varop'>&gt;&gt;&gt;</span> <span class='hs-varid'>arr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>head</span><span class='hs-layout'>)</span>
<a name="line-219"></a>
<a name="line-220"></a><span class='hs-comment'>-- | Event source with consecutive occurrences at the given intervals.</span>
<a name="line-221"></a><span class='hs-comment'>-- Should more than one event be scheduled to occur in any sampling interval,</span>
<a name="line-222"></a><span class='hs-comment'>-- the output list will contain all events produced during that interval.</span>
<a name="line-223"></a>
<a name="line-224"></a><a name="afterEachCat"></a><span class='hs-comment'>-- Guaranteed not to miss any events.</span>
<a name="line-225"></a><span class='hs-definition'>afterEachCat</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Time</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-226"></a><span class='hs-definition'>afterEachCat</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>never</span>
<a name="line-227"></a><span class='hs-definition'>afterEachCat</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>qxs</span><span class='hs-layout'>)</span>
<a name="line-228"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usrErr</span> <span class='hs-str'>"AFRP"</span> <span class='hs-str'>"afterEachCat"</span> <span class='hs-str'>"Negative period."</span>
<a name="line-229"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>{</span><span class='hs-varid'>sfTF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tf0</span><span class='hs-layout'>}</span>
<a name="line-230"></a>    <span class='hs-keyword'>where</span>
<a name="line-231"></a>        <span class='hs-varid'>tf0</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>q</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span>
<a name="line-232"></a>                    <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-num'>0.0</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>qxs</span>
<a name="line-233"></a>                <span class='hs-keyword'>else</span>
<a name="line-234"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>awaitNextEvent</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-varid'>qxs</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-235"></a>
<a name="line-236"></a>        <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>xs</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>sfNever</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-237"></a>        <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>t</span> <span class='hs-varid'>xs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>qxs</span><span class='hs-layout'>)</span>
<a name="line-238"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usrErr</span> <span class='hs-str'>"AFRP"</span> <span class='hs-str'>"afterEachCat"</span> <span class='hs-str'>"Negative period."</span>
<a name="line-239"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>t'</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varid'>qxs</span>
<a name="line-240"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>awaitNextEvent</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>x</span> <span class='hs-varid'>qxs</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-241"></a>            <span class='hs-keyword'>where</span>
<a name="line-242"></a>                <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-comment'>-</span> <span class='hs-varid'>q</span>
<a name="line-243"></a>        <span class='hs-varid'>awaitNextEvent</span> <span class='hs-varid'>t</span> <span class='hs-varid'>x</span> <span class='hs-varid'>qxs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF'</span> <span class='hs-varid'>tf</span> <span class='hs-comment'>-- False</span>
<a name="line-244"></a>            <span class='hs-keyword'>where</span>
<a name="line-245"></a>                <span class='hs-varid'>tf</span> <span class='hs-varid'>dt</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>qxs</span>
<a name="line-246"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>awaitNextEvent</span> <span class='hs-varid'>t'</span> <span class='hs-varid'>x</span> <span class='hs-varid'>qxs</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-247"></a>                    <span class='hs-keyword'>where</span>
<a name="line-248"></a>                        <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span> <span class='hs-varop'>+</span> <span class='hs-varid'>dt</span>
<a name="line-249"></a>
<a name="line-250"></a><span class='hs-comment'>-- | Delay for events. (Consider it a triggered after, hence /basic/.)</span>
<a name="line-251"></a>
<a name="line-252"></a><span class='hs-comment'>-- Can be implemented fairly cheaply as long as the events are sparse.</span>
<a name="line-253"></a><span class='hs-comment'>-- It is a question of rescheduling events for later. Not unlike "afterEach".</span>
<a name="line-254"></a><span class='hs-comment'>--</span>
<a name="line-255"></a><span class='hs-comment'>-- It is not exactly the case that delayEvent t = delay t NoEvent</span>
<a name="line-256"></a><span class='hs-comment'>-- since the rules for dropping/extrapolating samples are different.</span>
<a name="line-257"></a><span class='hs-comment'>-- A single event occurrence will never be duplicated.</span>
<a name="line-258"></a><span class='hs-comment'>-- If there is an event occurrence, one will be output as soon as</span>
<a name="line-259"></a><span class='hs-comment'>-- possible after the given delay time, but not necessarily that</span>
<a name="line-260"></a><span class='hs-comment'>-- one.  See delayEventCat.</span>
<a name="line-261"></a>
<a name="line-262"></a><a name="delayEvent"></a><span class='hs-definition'>delayEvent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Time</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-263"></a><span class='hs-definition'>delayEvent</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usrErr</span> <span class='hs-str'>"AFRP"</span> <span class='hs-str'>"delayEvent"</span> <span class='hs-str'>"Negative delay."</span>
<a name="line-264"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>identity</span>
<a name="line-265"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delayEventCat</span> <span class='hs-varid'>q</span> <span class='hs-varop'>&gt;&gt;&gt;</span> <span class='hs-varid'>arr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>head</span><span class='hs-layout'>)</span>
<a name="line-266"></a>
<a name="line-267"></a>
<a name="line-268"></a><span class='hs-comment'>-- There is no *guarantee* above that every event actually will be</span>
<a name="line-269"></a><span class='hs-comment'>-- rescheduled since the sampling frequency (temporarily) might drop.</span>
<a name="line-270"></a><span class='hs-comment'>-- The following interface would allow ALL scheduled events to occur</span>
<a name="line-271"></a><span class='hs-comment'>-- as soon as possible:</span>
<a name="line-272"></a><span class='hs-comment'>-- (Read "delay event and catenate events that occur so closely so as to be</span>
<a name="line-273"></a><span class='hs-comment'>-- inseparable".)</span>
<a name="line-274"></a><span class='hs-comment'>-- The events in the list are ordered temporally to the extent possible.</span>
<a name="line-275"></a>
<a name="line-276"></a><span class='hs-comment'>{-
<a name="line-277"></a>-- This version is too strict!
<a name="line-278"></a>delayEventCat :: Time -&gt; SF (Event a) (Event [a])
<a name="line-279"></a>delayEventCat q | q &lt; 0     = usrErr "AFRP" "delayEventCat" "Negative delay."
<a name="line-280"></a>                | q == 0    = arr (fmap (:[]))
<a name="line-281"></a>                | otherwise = SF {sfTF = tf0}
<a name="line-282"></a>    where
<a name="line-283"></a>        tf0 NoEvent   = (noPendingEvent, NoEvent)
<a name="line-284"></a>        tf0 (Event x) = (pendingEvents (-q) [] [] (-q) x, NoEvent)
<a name="line-285"></a>
<a name="line-286"></a>        noPendingEvent = SF' tf -- True
<a name="line-287"></a>            where
<a name="line-288"></a>                tf _ NoEvent   = (noPendingEvent, NoEvent)
<a name="line-289"></a>                tf _ (Event x) = (pendingEvents (-q) [] [] (-q) x, NoEvent)
<a name="line-290"></a>                                 
<a name="line-291"></a>        -- t_next is the present time w.r.t. the next scheduled event.
<a name="line-292"></a>        -- t_last is the present time w.r.t. the last scheduled event.
<a name="line-293"></a>        -- In the event queues, events are associated with their time
<a name="line-294"></a>        -- w.r.t. to preceding event (positive).
<a name="line-295"></a>        pendingEvents t_last rqxs qxs t_next x = SF' tf -- True
<a name="line-296"></a>            where
<a name="line-297"></a>                tf dt NoEvent    = tf1 (t_last + dt) rqxs (t_next + dt)
<a name="line-298"></a>                tf dt (Event x') = tf1 (-q) ((q', x') : rqxs) t_next'
<a name="line-299"></a>                    where
<a name="line-300"></a>                        t_next' = t_next  + dt
<a name="line-301"></a>                        t_last' = t_last  + dt
<a name="line-302"></a>                        q'      = t_last' + q
<a name="line-303"></a>
<a name="line-304"></a>                tf1 t_last' rqxs' t_next'
<a name="line-305"></a>                    | t_next' &gt;= 0 =
<a name="line-306"></a>                        emitEventsScheduleNext t_last' rqxs' qxs t_next' [x]
<a name="line-307"></a>                    | otherwise =
<a name="line-308"></a>                        (pendingEvents t_last' rqxs' qxs t_next' x, NoEvent)
<a name="line-309"></a>
<a name="line-310"></a>        -- t_next is the present time w.r.t. the *scheduled* time of the
<a name="line-311"></a>        -- event that is about to be emitted (i.e. &gt;= 0).
<a name="line-312"></a>        -- The time associated with any event at the head of the event
<a name="line-313"></a>        -- queue is also given w.r.t. the event that is about to be emitted.
<a name="line-314"></a>        -- Thus, t_next - q' is the present time w.r.t. the event at the head
<a name="line-315"></a>        -- of the event queue.
<a name="line-316"></a>        emitEventsScheduleNext t_last [] [] t_next rxs =
<a name="line-317"></a>            (noPendingEvent, Event (reverse rxs))
<a name="line-318"></a>        emitEventsScheduleNext t_last rqxs [] t_next rxs =
<a name="line-319"></a>            emitEventsScheduleNext t_last [] (reverse rqxs) t_next rxs
<a name="line-320"></a>        emitEventsScheduleNext t_last rqxs ((q', x') : qxs') t_next rxs
<a name="line-321"></a>            | q' &gt; t_next = (pendingEvents t_last rqxs qxs' (t_next - q') x',
<a name="line-322"></a>                             Event (reverse rxs))
<a name="line-323"></a>            | otherwise   = emitEventsScheduleNext t_last rqxs qxs' (t_next-q')
<a name="line-324"></a>                                                   (x' : rxs)
<a name="line-325"></a>-}</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="delayEventCat"></a><span class='hs-comment'>-- | Delay an event by a given delta and catenate events that occur so closely</span>
<a name="line-328"></a><span class='hs-comment'>-- so as to be /inseparable/.</span>
<a name="line-329"></a><span class='hs-definition'>delayEventCat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Time</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-330"></a><span class='hs-definition'>delayEventCat</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>0</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>usrErr</span> <span class='hs-str'>"AFRP"</span> <span class='hs-str'>"delayEventCat"</span> <span class='hs-str'>"Negative delay."</span>
<a name="line-331"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-332"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>{</span><span class='hs-varid'>sfTF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tf0</span><span class='hs-layout'>}</span>
<a name="line-333"></a>    <span class='hs-keyword'>where</span>
<a name="line-334"></a>        <span class='hs-varid'>tf0</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-335"></a>                     <span class='hs-conid'>NoEvent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noPendingEvent</span>
<a name="line-336"></a>                     <span class='hs-conid'>Event</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pendingEvents</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span>
<a name="line-337"></a>                 <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-338"></a>
<a name="line-339"></a>        <span class='hs-varid'>noPendingEvent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF'</span> <span class='hs-varid'>tf</span> <span class='hs-comment'>-- True</span>
<a name="line-340"></a>            <span class='hs-keyword'>where</span>
<a name="line-341"></a>                <span class='hs-varid'>tf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-342"></a>                              <span class='hs-conid'>NoEvent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noPendingEvent</span>
<a name="line-343"></a>                              <span class='hs-conid'>Event</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pendingEvents</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span>
<a name="line-344"></a>                          <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-345"></a>                                 
<a name="line-346"></a>        <span class='hs-comment'>-- t_next is the present time w.r.t. the next scheduled event.</span>
<a name="line-347"></a>        <span class='hs-comment'>-- t_last is the present time w.r.t. the last scheduled event.</span>
<a name="line-348"></a>        <span class='hs-comment'>-- In the event queues, events are associated with their time</span>
<a name="line-349"></a>        <span class='hs-comment'>-- w.r.t. to preceding event (positive).</span>
<a name="line-350"></a>        <span class='hs-varid'>pendingEvents</span> <span class='hs-varid'>t_last</span> <span class='hs-varid'>rqxs</span> <span class='hs-varid'>qxs</span> <span class='hs-varid'>t_next</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF'</span> <span class='hs-varid'>tf</span> <span class='hs-comment'>-- True</span>
<a name="line-351"></a>            <span class='hs-keyword'>where</span>
<a name="line-352"></a>                <span class='hs-varid'>tf</span> <span class='hs-varid'>dt</span> <span class='hs-varid'>e</span>
<a name="line-353"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>t_next'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span>
<a name="line-354"></a>                        <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t_last'</span> <span class='hs-varid'>rqxs</span> <span class='hs-varid'>qxs</span> <span class='hs-varid'>t_next'</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-355"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> 
<a name="line-356"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>pendingEvents</span> <span class='hs-varid'>t_last''</span> <span class='hs-varid'>rqxs'</span> <span class='hs-varid'>qxs</span> <span class='hs-varid'>t_next'</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-357"></a>                    <span class='hs-keyword'>where</span>
<a name="line-358"></a>                        <span class='hs-varid'>t_next'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t_next</span>  <span class='hs-varop'>+</span> <span class='hs-varid'>dt</span>
<a name="line-359"></a>                        <span class='hs-varid'>t_last'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t_last</span>  <span class='hs-varop'>+</span> <span class='hs-varid'>dt</span> 
<a name="line-360"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>t_last''</span><span class='hs-layout'>,</span> <span class='hs-varid'>rqxs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-361"></a>                            <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-362"></a>                                <span class='hs-conid'>NoEvent</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>t_last'</span><span class='hs-layout'>,</span> <span class='hs-varid'>rqxs</span><span class='hs-layout'>)</span>
<a name="line-363"></a>                                <span class='hs-conid'>Event</span> <span class='hs-varid'>x'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>t_last'</span><span class='hs-varop'>+</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>x'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rqxs</span><span class='hs-layout'>)</span>
<a name="line-364"></a>
<a name="line-365"></a>        <span class='hs-comment'>-- t_next is the present time w.r.t. the *scheduled* time of the</span>
<a name="line-366"></a>        <span class='hs-comment'>-- event that is about to be emitted (i.e. &gt;= 0).</span>
<a name="line-367"></a>        <span class='hs-comment'>-- The time associated with any event at the head of the event</span>
<a name="line-368"></a>        <span class='hs-comment'>-- queue is also given w.r.t. the event that is about to be emitted.</span>
<a name="line-369"></a>        <span class='hs-comment'>-- Thus, t_next - q' is the present time w.r.t. the event at the head</span>
<a name="line-370"></a>        <span class='hs-comment'>-- of the event queue.</span>
<a name="line-371"></a>        <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rxs</span> <span class='hs-keyglyph'>=</span>
<a name="line-372"></a>            <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-373"></a>                 <span class='hs-conid'>NoEvent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>noPendingEvent</span>
<a name="line-374"></a>                 <span class='hs-conid'>Event</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pendingEvents</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span> 
<a name="line-375"></a>             <span class='hs-conid'>Event</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rxs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-376"></a>        <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t_last</span> <span class='hs-varid'>rqxs</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>t_next</span> <span class='hs-varid'>rxs</span> <span class='hs-keyglyph'>=</span>
<a name="line-377"></a>            <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t_last</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rqxs</span><span class='hs-layout'>)</span> <span class='hs-varid'>t_next</span> <span class='hs-varid'>rxs</span>
<a name="line-378"></a>        <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>e</span> <span class='hs-varid'>t_last</span> <span class='hs-varid'>rqxs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>q'</span><span class='hs-layout'>,</span> <span class='hs-varid'>x'</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>qxs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>t_next</span> <span class='hs-varid'>rxs</span>
<a name="line-379"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q'</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>t_next</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-380"></a>                                 <span class='hs-conid'>NoEvent</span> <span class='hs-keyglyph'>-&gt;</span> 
<a name="line-381"></a>                                     <span class='hs-varid'>pendingEvents</span> <span class='hs-varid'>t_last</span> 
<a name="line-382"></a>                                                   <span class='hs-varid'>rqxs</span> 
<a name="line-383"></a>                                                   <span class='hs-varid'>qxs'</span>
<a name="line-384"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>t_next</span> <span class='hs-comment'>-</span> <span class='hs-varid'>q'</span><span class='hs-layout'>)</span>
<a name="line-385"></a>                                                   <span class='hs-varid'>x'</span>
<a name="line-386"></a>                                 <span class='hs-conid'>Event</span> <span class='hs-varid'>x''</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-387"></a>                                     <span class='hs-varid'>pendingEvents</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>q</span><span class='hs-layout'>)</span> 
<a name="line-388"></a>                                                   <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>t_last</span><span class='hs-varop'>+</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span> <span class='hs-varid'>x''</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rqxs</span><span class='hs-layout'>)</span>
<a name="line-389"></a>                                                   <span class='hs-varid'>qxs'</span>
<a name="line-390"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>t_next</span> <span class='hs-comment'>-</span> <span class='hs-varid'>q'</span><span class='hs-layout'>)</span>
<a name="line-391"></a>                                                   <span class='hs-varid'>x'</span><span class='hs-layout'>,</span>
<a name="line-392"></a>                             <span class='hs-conid'>Event</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>rxs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-393"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitEventsScheduleNext</span> <span class='hs-varid'>e</span>
<a name="line-394"></a>                                                   <span class='hs-varid'>t_last</span>
<a name="line-395"></a>                                                   <span class='hs-varid'>rqxs</span> 
<a name="line-396"></a>                                                   <span class='hs-varid'>qxs'</span> 
<a name="line-397"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>t_next</span> <span class='hs-comment'>-</span> <span class='hs-varid'>q'</span><span class='hs-layout'>)</span>
<a name="line-398"></a>                                                   <span class='hs-layout'>(</span><span class='hs-varid'>x'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rxs</span><span class='hs-layout'>)</span>
<a name="line-399"></a>
<a name="line-400"></a>
<a name="line-401"></a><span class='hs-comment'>-- | A rising edge detector. Useful for things like detecting key presses.</span>
<a name="line-402"></a><span class='hs-comment'>-- It is initialised as /up/, meaning that events occuring at time 0 will</span>
<a name="line-403"></a><span class='hs-comment'>-- not be detected.</span>
<a name="line-404"></a>
<a name="line-405"></a><a name="edge"></a><span class='hs-comment'>-- Note that we initialize the loop with state set to True so that there</span>
<a name="line-406"></a><span class='hs-comment'>-- will not be an occurence at t0 in the logical time frame in which</span>
<a name="line-407"></a><span class='hs-comment'>-- this is started.</span>
<a name="line-408"></a><span class='hs-definition'>edge</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SF</span> <span class='hs-conid'>Bool</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-409"></a><span class='hs-definition'>edge</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>iEdge</span> <span class='hs-conid'>True</span>
<a name="line-410"></a>
<a name="line-411"></a><a name="iEdge"></a><span class='hs-comment'>-- | A rising edge detector that can be initialized as up ('True', meaning</span>
<a name="line-412"></a><span class='hs-comment'>--   that events occurring at time 0 will not be detected) or down</span>
<a name="line-413"></a><span class='hs-comment'>--   ('False', meaning that events ocurring at time 0 will be detected).</span>
<a name="line-414"></a><span class='hs-definition'>iEdge</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-conid'>Bool</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-415"></a><span class='hs-comment'>-- iEdge i = edgeBy (isBoolRaisingEdge ()) i</span>
<a name="line-416"></a><span class='hs-definition'>iEdge</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sscanPrim</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-num'>2</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-conid'>NoEvent</span>
<a name="line-417"></a>    <span class='hs-keyword'>where</span>
<a name="line-418"></a>        <span class='hs-varid'>f</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-419"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>0</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-420"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>0</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Event</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-421"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>1</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-422"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>1</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-423"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>2</span> <span class='hs-conid'>False</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoEvent</span><span class='hs-layout'>)</span>
<a name="line-424"></a>        <span class='hs-varid'>f</span> <span class='hs-num'>2</span> <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-425"></a>        <span class='hs-varid'>f</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span>
<a name="line-426"></a>
<a name="line-427"></a><a name="edgeTag"></a><span class='hs-comment'>-- | Like 'edge', but parameterized on the tag value.</span>
<a name="line-428"></a><span class='hs-definition'>edgeTag</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-conid'>Bool</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-429"></a><span class='hs-comment'>-- edgeTag a = edgeBy (isBoolRaisingEdge a) True</span>
<a name="line-430"></a><span class='hs-definition'>edgeTag</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>edge</span> <span class='hs-varop'>&gt;&gt;&gt;</span> <span class='hs-varid'>arr</span> <span class='hs-layout'>(</span><span class='hs-varop'>`tag`</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-431"></a>
<a name="line-432"></a>
<a name="line-433"></a><span class='hs-comment'>-- Internal utility.</span>
<a name="line-434"></a><span class='hs-comment'>-- isBoolRaisingEdge :: a -&gt; Bool -&gt; Bool -&gt; Maybe a</span>
<a name="line-435"></a><span class='hs-comment'>-- isBoolRaisingEdge _ False False = Nothing</span>
<a name="line-436"></a><span class='hs-comment'>-- isBoolRaisingEdge a False True  = Just a</span>
<a name="line-437"></a><span class='hs-comment'>-- isBoolRaisingEdge _ True  True  = Nothing</span>
<a name="line-438"></a><span class='hs-comment'>-- isBoolRaisingEdge _ True  False = Nothing</span>
<a name="line-439"></a>
<a name="line-440"></a>
<a name="line-441"></a><span class='hs-comment'>-- | Edge detector particularized for detecting transtitions</span>
<a name="line-442"></a><span class='hs-comment'>--   on a 'Maybe' signal from 'Nothing' to 'Just'.</span>
<a name="line-443"></a>
<a name="line-444"></a><a name="edgeJust"></a><span class='hs-comment'>-- !!! 2005-07-09: To be done or eliminated</span>
<a name="line-445"></a><span class='hs-comment'>-- !!! Maybe could be kept as is, but could be easy to implement directly</span>
<a name="line-446"></a><span class='hs-comment'>-- !!! in terms of sscan?</span>
<a name="line-447"></a><span class='hs-definition'>edgeJust</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-448"></a><span class='hs-definition'>edgeJust</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>edgeBy</span> <span class='hs-varid'>isJustEdge</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>undefined</span><span class='hs-layout'>)</span>
<a name="line-449"></a>    <span class='hs-keyword'>where</span>
<a name="line-450"></a>        <span class='hs-varid'>isJustEdge</span> <span class='hs-conid'>Nothing</span>  <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-451"></a>        <span class='hs-varid'>isJustEdge</span> <span class='hs-conid'>Nothing</span>  <span class='hs-varid'>ma</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ma</span>
<a name="line-452"></a>        <span class='hs-varid'>isJustEdge</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-453"></a>        <span class='hs-varid'>isJustEdge</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-454"></a>
<a name="line-455"></a>
<a name="line-456"></a><span class='hs-comment'>-- | Edge detector parameterized on the edge detection function and initial</span>
<a name="line-457"></a><span class='hs-comment'>-- state, i.e., the previous input sample. The first argument to the</span>
<a name="line-458"></a><span class='hs-comment'>-- edge detection function is the previous sample, the second the current one.</span>
<a name="line-459"></a>
<a name="line-460"></a><a name="edgeBy"></a><span class='hs-comment'>-- !!! Is this broken!?! Does not disallow an edge condition that persists</span>
<a name="line-461"></a><span class='hs-comment'>-- !!! between consecutive samples. See discussion in ToDo list above.</span>
<a name="line-462"></a><span class='hs-comment'>-- !!! 2005-07-09: To be done.</span>
<a name="line-463"></a><span class='hs-definition'>edgeBy</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-464"></a><span class='hs-definition'>edgeBy</span> <span class='hs-varid'>isEdge</span> <span class='hs-varid'>a_init</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>{</span><span class='hs-varid'>sfTF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tf0</span><span class='hs-layout'>}</span>
<a name="line-465"></a>    <span class='hs-keyword'>where</span>
<a name="line-466"></a>        <span class='hs-varid'>tf0</span> <span class='hs-varid'>a0</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ebAux</span> <span class='hs-varid'>a0</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeToEvent</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEdge</span> <span class='hs-varid'>a_init</span> <span class='hs-varid'>a0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-467"></a>
<a name="line-468"></a>        <span class='hs-varid'>ebAux</span> <span class='hs-varid'>a_prev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SF'</span> <span class='hs-varid'>tf</span> <span class='hs-comment'>-- True</span>
<a name="line-469"></a>            <span class='hs-keyword'>where</span>
<a name="line-470"></a>                <span class='hs-varid'>tf</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ebAux</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeToEvent</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEdge</span> <span class='hs-varid'>a_prev</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-471"></a>
<a name="line-472"></a>
<a name="line-473"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-474"></a><span class='hs-comment'>-- Stateful event suppression</span>
<a name="line-475"></a><span class='hs-comment'>------------------------------------------------------------------------------</span>
<a name="line-476"></a>
<a name="line-477"></a><a name="notYet"></a><span class='hs-comment'>-- | Suppression of initial (at local time 0) event.</span>
<a name="line-478"></a><span class='hs-definition'>notYet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-479"></a><span class='hs-definition'>notYet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initially</span> <span class='hs-conid'>NoEvent</span>
<a name="line-480"></a>
<a name="line-481"></a>
<a name="line-482"></a><a name="once"></a><span class='hs-comment'>-- | Suppress all but the first event.</span>
<a name="line-483"></a><span class='hs-definition'>once</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-484"></a><span class='hs-definition'>once</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeEvents</span> <span class='hs-num'>1</span>
<a name="line-485"></a>
<a name="line-486"></a>
<a name="line-487"></a><a name="takeEvents"></a><span class='hs-comment'>-- | Suppress all but the first n events.</span>
<a name="line-488"></a><span class='hs-definition'>takeEvents</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-489"></a><span class='hs-definition'>takeEvents</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>never</span>
<a name="line-490"></a><span class='hs-definition'>takeEvents</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dSwitch</span> <span class='hs-layout'>(</span><span class='hs-varid'>arr</span> <span class='hs-varid'>dup</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-conid'>NoEvent</span> <span class='hs-varop'>&gt;--</span> <span class='hs-varid'>takeEvents</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-491"></a>
<a name="line-492"></a>
<a name="line-493"></a><span class='hs-comment'>{-
<a name="line-494"></a>-- More complicated using "switch" that "dSwitch".
<a name="line-495"></a>takeEvents :: Int -&gt; SF (Event a) (Event a)
<a name="line-496"></a>takeEvents 0       = never
<a name="line-497"></a>takeEvents (n + 1) = switch (never &amp;&amp;&amp; identity) (takeEvents' n)
<a name="line-498"></a>    where
<a name="line-499"></a>        takeEvents' 0       a = now a
<a name="line-500"></a>        takeEvents' (n + 1) a = switch (now a &amp;&amp;&amp; notYet) (takeEvents' n)
<a name="line-501"></a>-}</span>
<a name="line-502"></a>
<a name="line-503"></a>
<a name="line-504"></a><span class='hs-comment'>-- | Suppress first n events.</span>
<a name="line-505"></a>
<a name="line-506"></a><a name="dropEvents"></a><span class='hs-comment'>-- Here dSwitch or switch does not really matter.</span>
<a name="line-507"></a><span class='hs-definition'>dropEvents</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SF</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Event</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-508"></a><span class='hs-definition'>dropEvents</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>identity</span>
<a name="line-509"></a><span class='hs-definition'>dropEvents</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dSwitch</span> <span class='hs-layout'>(</span><span class='hs-varid'>never</span> <span class='hs-varop'>&amp;&amp;&amp;</span> <span class='hs-varid'>identity</span><span class='hs-layout'>)</span>
<a name="line-510"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-layout'>(</span><span class='hs-conid'>NoEvent</span> <span class='hs-varop'>&gt;--</span> <span class='hs-varid'>dropEvents</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-511"></a>
<a name="line-512"></a><span class='hs-comment'>-- Vim modeline</span>
<a name="line-513"></a><span class='hs-comment'>-- vim:set tabstop=8 expandtab:</span>
</pre></body>
</html>
